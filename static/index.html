<!DOCTYPE html>
<html lang = 'en' ng-app = 'myApp'>
	<head>
		<meta charset = 'UTF-8'>
		<title>Products and Quantities</title>

		<!-- Bootstrap -->
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>

		<script src = '/bower_components/angular/angular.js'></script>

		<script type = 'text/javascript'>
			var myAppModule = angular.module('myApp', []);

			//products factory
			myAppModule.factory('productFactory', function() {
				var products = [
					{name: 'computer', price: 1499.99, quantity: 45},
					{name: 'water bottle', price: 7.99, quantity: 34},
					{name: 'fig bar', price: 0.99, quantity: 12}
				];
				var factory = {};

				//get all products
				factory.index = function(callback) {
					callback(products);
				}

				//delete product
				factory.delete = function(product, callback) {
					products.splice(products.indexOf(product), 1);
					callback(products);
				}

				//add product
				factory.add = function(product, callback) {
					//only add if price is a number
					if (product.price && Number(parseFloat(product.price)) == product.price) {
						product.price = parseFloat(product.price);
						products.push(product);
						callback(products);
					}
				}

				//buy product (decrease quantity)
				factory.buy = function(product, callback) {
					products[products.indexOf(product)].quantity--;
					callback(products);
				}

				return factory;
			});

			//products controller
			myAppModule.controller('productsController', function($scope, productFactory) {

				//initialize empty products array and new product object
				$scope.products = [];
				$scope.product = {quantity: 50};

				//use this as a callback
				function setProducts(data) {
					$scope.products = data;
					$scope.product = {quantity: 50};
				}

				//get all products from factory
				productFactory.index(setProducts);

				//delete product
				$scope.delete = function(product) {
					productFactory.delete(product, setProducts)
				}

				//add product
				$scope.add = function() {
					productFactory.add($scope.product, setProducts);
				}
			});

			//quantities controller
			myAppModule.controller('quantitiesController', function($scope, productFactory) {

				$scope.products = [];
				function setProducts(data) {
					$scope.products = data;
				}

				//get all products from factory
				productFactory.index(setProducts);

				//buy product
				$scope.buy = function(product) {
					productFactory.buy(product, setProducts);
				}

			})


		</script>


	</head>
	<body>
		<div ng-controller = 'productsController'>

			<div class = 'col-md-4'>
				<h3>Add New Product</h3>
				<form ng-submit = 'add()'>
					<label>Product Name:</label>
					<input class = 'form-control' type = 'text' ng-model = 'product.name' required>
					<label>Product Price:</label>
					<input class = 'form-control' type = 'text' ng-model = 'product.price' required>
					<br>
					<input class = 'btn btn-success pull-right' type = 'submit' value = 'Add Product'>
				</form>
			</div>

			<div class = 'col-md-7'>
				<h3>All Products</h3>
				<table class = 'table table-striped table-bordered'>
					<thead>
						<tr>
							<td>
								<a href = '' ng-click = "sortType = 'name'; sortReverse = !sortReverse">Name</a>
								<span ng-show = "sortType == 'name' && !sortReverse">v</span>
								<span ng-show = "sortType == 'name' && sortReverse">^</span>
							</td>
							<td>
								<a href = '' ng-click = "sortType = 'price'; sortReverse = !sortReverse">Price</a>
								<span ng-show = "sortType == 'price' && !sortReverse">v</span>
								<span ng-show = "sortType == 'price' && sortReverse">^</span>
							</td>
							<td>Actions</td>
						</tr>
					</thead>
					<tbody>
						<tr ng-repeat = 'product in products | orderBy:sortType:sortReverse track by $index'>
							<td>{{product.name}}</td>
							<td>{{product.price | currency}}</td>
							<td><button class = 'btn btn-warning btn-sm' ng-click = "delete(product)">Delete</button></td>
						</tr>
					</tbody>
				</table>
			</div>
		</div> <!-- end of productsController -->

		<div ng-controller = 'quantitiesController'>
			<div class = 'col-md-7'>
				<h3>All Products</h3>
				<table class = 'table table-striped table-bordered'>
					<thead>
						<tr>
							<td>
								<a href = '' ng-click = "sortType = 'name'; sortReverse = !sortReverse">Name</a>
								<span ng-show = "sortType == 'name' && !sortReverse">v</span>
								<span ng-show = "sortType == 'name' && sortReverse">^</span>
							</td>
							<td>
								<a href = '' ng-click = "sortType = 'price'; sortReverse = !sortReverse">Price</a>
								<span ng-show = "sortType == 'price' && !sortReverse">v</span>
								<span ng-show = "sortType == 'price' && sortReverse">^</span>
							</td>
							<td>
								<a href = '' ng-click = "sortType = 'quantity'; sortReverse = !sortReverse">Quantity Available</a>
								<span ng-show = "sortType == 'quantity' && !sortReverse">v</span>
								<span ng-show = "sortType == 'quantity' && sortReverse">^</span>
							</td>
							<td>Actions</td>
						</tr>
					</thead>
					<tbody>
						<tr ng-repeat = 'product in products | orderBy:sortType:sortReverse track by $index'>
							<td>{{product.name}}</td>
							<td>{{product.price | currency}}</td>
							<td>{{product.quantity}}</td>
							<td><button class = 'btn btn-primary btn-sm' ng-click = 'buy(product)'>Buy</button></td>
						</tr>
					</tbody>
				</table>
			</div>
		</div>

	</body>
</html>